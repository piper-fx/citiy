<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Money - Citizens Bank</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/min.css/min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .mobile-container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #c41e3a;
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
        }

        .header-back {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 80px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        select,
        input[type="text"],
        input[type="email"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        select:focus,
        input:focus,
        textarea:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #c41e3a 0%, #a01830 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(196, 30, 58, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2a5298;
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            color: #1565c0;
            margin-bottom: 18px;
        }

        .amount-display {
            background: #f9f9f9;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 18px;
            text-align: center;
        }

        .amount-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .amount-value {
            font-size: 32px;
            font-weight: 700;
            color: #28a745;
        }

        .recipient-info {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            border-left: 4px solid #28a745;
            display: none;
        }

        .recipient-info.show {
            display: block;
        }

        .recipient-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .recipient-account {
            font-size: 12px;
            color: #666;
        }

        .error-message {
            color: #c41e3a;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #e8f5e9;
            border: 1px solid #81c784;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        @media (max-width: 480px) {
            .mobile-container {
                box-shadow: none;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- Header -->
        <div class="header">
            <button class="header-back" onclick="goBack()">‚Üê</button>
            <div class="header-title">Request Money</div>
            <div style="width: 24px;"></div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="info-box">
                Request money from other Citizens Bank users or external contacts.
            </div>

            <div class="success-message" id="successMessage"></div>
            <div class="error-message" id="errorMessage"></div>

            <div class="form-group">
                <label>From which account do you want to receive?</label>
                <select id="toAccount">
                    <option value="">Select account...</option>
                </select>
                <div class="error-message" id="error1"></div>
            </div>

            <div class="form-group">
                <label>Request From (Account Number or Email)</label>
                <input 
                    type="text" 
                    id="fromAccount" 
                    placeholder="Enter account number or email"
                    onblur="lookupSender()"
                >
                <div class="error-message" id="error2"></div>
            </div>

            <div class="recipient-info" id="senderInfo">
                <div class="recipient-name" id="senderName"></div>
                <div class="recipient-account" id="senderAccount"></div>
            </div>

            <div class="form-group">
                <label>Amount to Request</label>
                <input 
                    type="number" 
                    id="amount" 
                    placeholder="0.00"
                    min="0"
                    step="0.01"
                    onchange="updateAmountDisplay()"
                >
                <div class="error-message" id="error3"></div>
            </div>

            <div class="amount-display" id="amountDisplay" style="display: none;">
                <div class="amount-label">Amount to request</div>
                <div class="amount-value" id="amountValue">$0.00</div>
            </div>

            <div class="form-group">
                <label>Reason for Request</label>
                <textarea 
                    id="description" 
                    placeholder="What is this request for?"
                    rows="3"
                ></textarea>
            </div>

            <button class="btn-primary" onclick="sendRequest()">Send Request</button>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item" onclick="window.location.href='app.html'">
                <span>üí∞</span>
                <span class="nav-item-label">Accounts</span>
            </button>
            <button class="nav-item" onclick="window.location.href='transfer-page.html'">
                <span>üîÑ</span>
                <span class="nav-item-label">Transfer</span>
            </button>
            <button class="nav-item active" onclick="#">
                <span>üì•</span>
                <span class="nav-item-label">Request</span>
            </button>
            <button class="nav-item" onclick="window.location.href='transactions.html'">
                <span>üìú</span>
                <span class="nav-item-label">History</span>
            </button>
            <button class="nav-item" onclick="window.location.href='profile.html'">
                <span>üë§</span>
                <span class="nav-item-label">Profile</span>
            </button>
        </div>
    </div>

    <script>
        let userAccounts = [];
        let requestData = {
            toAccount: null,
            fromAccount: null,
            amount: null,
            description: null
        };

        // Load accounts on page load
        window.addEventListener('load', loadAccounts);

        async function loadAccounts() {
            const userId = localStorage.getItem('userId');
            try {
                const response = await fetch(`/api/accounts/${userId}`);
                userAccounts = await response.json();
                
                const select = document.getElementById('toAccount');
                userAccounts.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.accountId;
                    option.textContent = `${acc.accountName} - ${acc.accountNumber}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        async function lookupSender() {
            const accountInput = document.getElementById('fromAccount').value;
            
            if (!accountInput) {
                document.getElementById('senderInfo').classList.remove('show');
                return;
            }

            try {
                // Try to find by account number first
                const response = await fetch(`/api/verify-account/${accountInput}`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('senderName').textContent = data.userName;
                    document.getElementById('senderAccount').textContent = `Account: ${data.accountNumber} - ${data.accountName}`;
                    document.getElementById('senderInfo').classList.add('show');
                    requestData.fromAccount = data.accountNumber;
                } else {
                    // If not found by account number, assume it's an email
                    document.getElementById('senderName').textContent = accountInput;
                    document.getElementById('senderAccount').textContent = 'External contact (will be notified via email)';
                    document.getElementById('senderInfo').classList.add('show');
                    requestData.fromAccount = accountInput;
                }
            } catch (error) {
                console.error('Lookup error:', error);
                document.getElementById('senderInfo').classList.remove('show');
            }
        }

        function updateAmountDisplay() {
            const amount = parseFloat(document.getElementById('amount').value);
            if (amount > 0) {
                document.getElementById('amountDisplay').style.display = 'block';
                document.getElementById('amountValue').textContent = `$${amount.toFixed(2)}`;
                requestData.amount = amount;
            }
        }

        async function sendRequest() {
            const toAccount = document.getElementById('toAccount').value;
            const fromAccount = document.getElementById('fromAccount').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;

            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));

            // Validation
            if (!toAccount) {
                document.getElementById('error1').textContent = 'Please select your account';
                document.getElementById('error1').classList.add('show');
                return;
            }

            if (!fromAccount) {
                document.getElementById('error2').textContent = 'Please enter sender details';
                document.getElementById('error2').classList.add('show');
                return;
            }

            if (!amount || amount <= 0) {
                document.getElementById('error3').textContent = 'Please enter a valid amount';
                document.getElementById('error3').classList.add('show');
                return;
            }

            try {
                // In a real app, this would create a payment request in the database
                // For now, we'll simulate it
                
                const selectedAccount = userAccounts.find(acc => acc.accountId === toAccount);
                
                // Create notification for the request
                const notification = {
                    title: 'Money Request Sent',
                    message: `You requested $${amount.toFixed(2)} from ${fromAccount}. They will be notified.`,
                    type: 'request'
                };

                document.getElementById('successMessage').textContent = 
                    `Request sent! You requested $${amount.toFixed(2)} from ${fromAccount}. ` +
                    `They will be notified to send the money to your ${selectedAccount.accountName} (${selectedAccount.accountNumber}).`;
                document.getElementById('successMessage').classList.add('show');

                // Clear form
                document.getElementById('toAccount').value = '';
                document.getElementById('fromAccount').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('description').value = '';
                document.getElementById('amountDisplay').style.display = 'none';
                document.getElementById('senderInfo').classList.remove('show');

                // Scroll to top to show success message
                window.scrollTo(0, 0);

            } catch (error) {
                console.error('Request error:', error);
                document.getElementById('errorMessage').textContent = 'Failed to send request. Please try again.';
                document.getElementById('errorMessage').classList.add('show');
            }
        }

        function goBack() {
            window.history.back();
        }

        // Add bottom nav styles
        const style = document.createElement('style');
        style.textContent = `
            .bottom-nav {
                position: fixed;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 100%;
                max-width: 480px;
                height: 70px;
                background: white;
                border-top: 1px solid #ddd;
                display: flex;
                justify-content: space-around;
                z-index: 20;
            }
            .nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 4px;
                flex: 1;
                cursor: pointer;
                background: none;
                border: none;
                font-size: 20px;
                color: #999;
                text-decoration: none;
            }
            .nav-item.active {
                color: #c41e3a;
            }
            .nav-item-label {
                font-size: 10px;
                color: inherit;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
